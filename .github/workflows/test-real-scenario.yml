name: Real Scenario Test

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  test-repo:
    name: Real Scenario Test
    runs-on: ubuntu-latest

    steps:
      - name: Create and clone test fork
        run: |
          # Delete existing fork if it exists
          if gh repo view majikmate/assignment-pull-request-test >/dev/null 2>&1; then
            echo "Deleting existing fork..."
            gh repo delete majikmate/assignment-pull-request-test --yes
          fi

          # Create fresh fork and clone it directly
          echo "Creating fresh fork and cloning..."
          gh repo fork majikmate/assignment-pull-request --repo-name assignment-pull-request-test --clone
          cd assignment-pull-request-test
          git config user.name "GitHub Actions Test"
          git config user.email "actions@github.com"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean and create test workflow in fork
        working-directory: ./assignment-pull-request-test
        run: |
          # Remove entire .github folder for clean slate
          echo "Removing entire .github folder..."
          rm -rf .github

          # Create .github/workflows directory
          mkdir -p .github/workflows

          # Create a test workflow that runs the action on test fixtures
          cat > .github/workflows/test-action.yml << 'EOF'
          name: Test Assignment PR Action

          on:
            workflow_dispatch:
            push:
              branches: [main]

          permissions:
            contents: write
            pull-requests: write

          jobs:
            assignment-pull-request:
              name: Test Real Assignment Processing
              runs-on: ubuntu-latest

              steps:
                - name: Checkout repository
                  uses: actions/checkout@v5

                - name: Run assignment PR creator
                  uses: majikmate/assignment-pull-request@main
                  with:
                    github-token: ${{ secrets.GITHUB_TOKEN }}
                    assignment-regex: >
                      ^test/fixtures/assignments/(assignment-[\d]+)$,
                      ^test/fixtures/homework/(hw-[\d]+)$,
                      ^test/fixtures/labs/(lab-[\d]+)$,
                      ^test/fixtures/bootcamp/(.+/assignment-[\w\-]+)$,
                      ^test/fixtures/courses/(.+/assignment-[\w\-]+)$
                    default-branch: main
                    dry-run: "no"
          EOF

          # Commit and push the changes (removal + new workflow)
          git add .
          git commit -m "Replace .github folder with test workflow"
          git push origin main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger test workflow in fork
        run: |
          # Trigger the workflow we just created
          gh workflow run test-action.yml --repo majikmate/assignment-pull-request-test

          # Wait a moment for the workflow to start
          echo "Waiting for workflow to start..."
          sleep 10

          # Check workflow status
          echo "Checking workflow runs..."
          gh run list --repo majikmate/assignment-pull-request-test --limit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify results
        run: |
          echo "🔍 Checking for created branches in test fork..."
          gh api repos/majikmate/assignment-pull-request-test/branches --jq '.[].name' | grep -E "(assignment-|hw-|lab-)" || echo "No assignment branches found yet"

          echo "🔍 Checking for created pull requests..."
          gh pr list --repo majikmate/assignment-pull-request-test

          echo "🔍 Checking recent workflow runs..."
          gh run list --repo majikmate/assignment-pull-request-test --limit 3

          echo "✅ Test fork created and workflow triggered"
          echo "🔗 Check the test repository: https://github.com/majikmate/assignment-pull-request-test"
          echo "🔗 Check workflow runs: https://github.com/majikmate/assignment-pull-request-test/actions"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
