name: Test Action

on:
  workflow_dispatch:
    inputs:
      assignments-root-regex:
        description: "Regex pattern for assignment root folders"
        required: false
        default: "^assignments$"
      assignment-regex:
        description: "Regex pattern for assignment folders"
        required: false
        default: '^assignment-\d+$'
      default-branch:
        description: "Default branch for pull requests"
        required: false
        default: "main"
      dry-run:
        description: "Run in dry-run mode (no actual changes)"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  test-action:
    runs-on: ubuntu-latest
    name: Test Assignment PR Creator Action
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Assignment PR Creator
        id: assignment-pr
        uses: ./
        with:
          assignments-root-regex: ${{ github.event.inputs.assignments-root-regex || '^assignments$' }}
          assignment-regex: ${{ github.event.inputs.assignment-regex || '^assignment-\d+$' }}
          default-branch: ${{ github.event.inputs.default-branch || 'main' }}
          dry-run: ${{ github.event.inputs.dry-run || 'true' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Display results
        run: |
          echo "## üìä Assignment PR Creator Results"
          echo ""
          echo "### Configuration:"
          echo "- Root Regex: \`${{ github.event.inputs.assignments-root-regex || '^assignments$' }}\`"
          echo "- Assignment Regex: \`${{ github.event.inputs.assignment-regex || '^assignment-\d+$' }}\`"
          echo "- Default Branch: \`${{ github.event.inputs.default-branch || 'main' }}\`"
          echo "- Dry Run: \`${{ github.event.inputs.dry-run || 'true' }}\`"
          echo ""

          # Get outputs safely
          BRANCHES='${{ steps.assignment-pr.outputs.created-branches || '[]' }}'
          PRS='${{ steps.assignment-pr.outputs.created-pull-requests || '[]' }}'

          # Count items
          BRANCH_COUNT=$(echo "$BRANCHES" | jq 'length // 0' 2>/dev/null || echo "0")
          PR_COUNT=$(echo "$PRS" | jq 'length // 0' 2>/dev/null || echo "0")

          echo "### Summary:"
          echo "- **Branches created:** $BRANCH_COUNT"
          echo "- **Pull requests created:** $PR_COUNT"

          # List details if available
          if [ "$BRANCH_COUNT" -gt 0 ] && [ "$BRANCHES" != "[]" ]; then
            echo ""
            echo "### üåø Created Branches:"
            echo "$BRANCHES" | jq -r '.[] // empty' | sed 's/^/- `/' | sed 's/$/`/'
          fi

          if [ "$PR_COUNT" -gt 0 ] && [ "$PRS" != "[]" ]; then
            echo ""
            echo "### üîÑ Created Pull Requests:"
            echo "$PRS" | jq -r '.[] // empty' | sed 's/^/- #/'
          fi

          echo ""
          if [ "${{ github.event.inputs.dry-run || 'true' }}" = "true" ]; then
            echo "üîç **Dry run completed** - No actual changes were made"
          else
            echo "‚úÖ **Live run completed** - Changes were applied to repository"
          fi
